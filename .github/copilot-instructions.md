# Copilot Instructions

## Build, lint, and validation commands

- Install deps: `bun install`
- Dev server: `bun run dev` (Astro on `http://localhost:4321`)
- Production build: `bun run build`
  - This runs `astro check && astro build && pagefind --site dist && cp -r dist/pagefind public/`
- Preview built site: `bun run preview`
- Sync Astro types: `bun run sync`
- Lint all files: `bun run lint`
- Lint a single file: `bun run lint -- src/path/to/file.ts`
- Format check: `bun run format:check`
- Format write: `bun run format`

### Tests

- There is no automated test suite configured (`package.json` has no `test` script).
- `.github/CONTRIBUTING.md` also notes that testing is currently manual.
- For focused verification, use single-file lint (`bun run lint -- <file>`) plus a full build (`bun run build`).

## High-level architecture

- **Framework/runtime**: Astro 5 with strict TypeScript, Tailwind v4, and a small React island (`src/components/Comments.tsx` for Giscus).
- **Content pipeline**: blog content is file-based Markdown in `src/data/blog/**`. The schema is enforced in `src/content.config.ts` via `defineCollection` + zod.
- **Manual i18n routing**:
  - `astro.config.ts` enables `i18n.routing = "manual"`.
  - Locale definitions/aliases live in `src/i18n/config.ts`.
  - Actual route generation is file-based under `src/pages/[lang]/...`, usually with `getStaticPaths()` from `src/i18n/utils.ts`.
  - Root routes like `/search`, `/tags`, `/about`, `/archives`, and `/posts/:slug` are redirect shims to localized routes.
- **Feature flags control both UI and route output**:
  - `src/config.ts` (`SITE.pages.*`, `SITE.showArchives`) gates nav rendering and static path generation.
  - Disabled pages typically return empty `getStaticPaths()` and redirect runtime access to `/404`.
- **Post URL and locale handling**:
  - Canonical slug generation is centralized in `src/utils/getPath.ts` (`getCanonicalSlug`, `getPath`).
  - Locale segments in folder paths or slug overrides are normalized out, then locale prefixes are added back by route helpers.
- **Cross-cutting generated outputs**:
  - RSS endpoints: `src/pages/rss.xml.ts` and `src/pages/[lang]/rss.xml.ts`
  - Dynamic OG image endpoints: `src/pages/og.png.ts`, `src/pages/[lang]/posts/[...slug]/index.png.ts`
  - Search index is generated by Pagefind during `bun run build`.

## Key repository conventions

- Prefer `@/` path aliases (configured in `tsconfig.json`) over deep relative imports.
- For localized pages, follow the pattern:
  1. `const { lang } = Astro.params`
  2. `const locale = getLocaleConfig(lang).code`
  3. Use localized helpers/text via `t(...)`, `getLocalePath(...)`, etc.
- Keep **rich page content** in Markdown data files and **UI labels** in i18n YAML:
  - Rich content: `src/data/index/*.md`, `src/data/about/*.md`
  - UI strings: `src/data/i18n/*.yaml`
- Posts should live under language folders (`src/data/blog/en`, `src/data/blog/zh`) and include `lang` in frontmatter.
- Build post links with `getPath(...)`; do not handcraft `/[lang]/posts/...` URLs.
- Reuse post utilities (`getSortedPosts`, `postFilter`, `getUniqueTags`, `getUniqueCategories`) instead of duplicating filtering/sorting logic.
- Respect `SITE.pages.*` and `SITE.showArchives` checks in new navigation, route, and link code to avoid dead links when sections are disabled.
- When adding a social/share platform, update both config (`src/config.ts`) and platform metadata mapping (`src/constants.ts`).
- Lint is strict about `console` usage (`no-console: "error"` in `eslint.config.js`).
