name: æ„å»ºä¸éƒ¨ç½²

on:
  push:
    branches: [main]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production
    concurrency: production

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # æµ…å…‹éš†ï¼Œæé«˜é€Ÿåº¦

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: å®‰è£… Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: å®‰è£…ä¾èµ–
        run: bun install --frozen-lockfile

      - name: æ„å»ºé¡¹ç›®
        run: bun run build

      - name: éƒ¨ç½²åˆ° gh-pages åˆ†æ”¯
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          publish_branch: gh-pages
          cname: blog.wenjiexu.site
          commit_message: "Deploy: ${{ github.event.head_commit.message }}"

      - name: æœåŠ¡å™¨æ‰§è¡Œéƒ¨ç½²å‘½ä»¤
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          script: |
            set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

            cd /opt/1panel/apps/openresty/openresty/www/sites/blog.wenjiexu.site/BlogPage

            # è®¾ç½®ä»£ç†åŠ é€Ÿ
            git remote set-url origin https://gh.xmly.dev/https://github.com/WayneXuCN/BlogPage

            # æ‹‰å–æœ€æ–°ä»£ç ï¼ˆgh-pages åˆ†æ”¯ï¼‰
            git config --global --add safe.directory "$(pwd)"
            git fetch origin gh-pages --depth=1

            # æ¸…ç©º index ç›®å½•
            rm -rf /opt/1panel/apps/openresty/openresty/www/sites/blog.wenjiexu.site/index/*

            # ä» gh-pages åˆ†æ”¯æ£€å‡ºæ–‡ä»¶åˆ° index ç›®å½•
            git --work-tree=/opt/1panel/apps/openresty/openresty/www/sites/blog.wenjiexu.site/index checkout origin/gh-pages -- .

            # è®¾ç½® index æ–‡ä»¶æƒé™ä¸º PHP-FPM ç”¨æˆ·
            chown -R 1000:1000 /opt/1panel/apps/openresty/openresty/www/sites/blog.wenjiexu.site/index

            echo "âœ… å·²ä» gh-pages åˆ†æ”¯æ‹‰å–æœ€æ–°æ„å»ºæ–‡ä»¶"
            echo "âœ… index ç›®å½•æ–‡ä»¶æƒé™å·²è®¾ç½®ä¸º 1000:1000"
            echo "ğŸš€ éƒ¨ç½²å®Œæˆæ—¶é—´: $(date)"
