---
import { getCollection } from "astro:content";
import { getCanonicalSlug } from "@/utils/getPath";
import { getLocalePath } from "@/i18n";
import { DEFAULT_LOCALE, type LocaleCode } from "@/i18n/config";
import { SITE } from "@/config";

export async function getStaticPaths() {
  if (!SITE.pages.posts.enabled) return [];

  const defaultLocale = DEFAULT_LOCALE.code as LocaleCode;
  const posts = await getCollection(
    "blog",
    ({ data }) => !data.draft && data.lang === defaultLocale
  );

  return posts.map(post => ({
    params: { slug: getCanonicalSlug(post.id, post.filePath, post.data.slug) },
  }));
}

const { slug = "" } = Astro.params;

if (!SITE.pages.posts.enabled) {
  return Astro.redirect("/404", 302);
}

const normalizedSlug = Array.isArray(slug) ? slug.join("/") : slug;
const redirectTarget = `${getLocalePath(DEFAULT_LOCALE.code as LocaleCode)}/posts/${normalizedSlug}`;

if (!redirectTarget) {
  throw new Error("Failed to build redirect target for post slug");
}

return Astro.redirect(redirectTarget, 308);
---
