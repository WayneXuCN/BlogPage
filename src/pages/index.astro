---
import { DEFAULT_LOCALE, SUPPORTED_LOCALES } from "@/i18n/config";

const localePaths = SUPPORTED_LOCALES.map(locale => ({
  path: locale.path,
  aliases: [locale.code, ...(locale.aliases ?? [])],
}));

const defaultRedirectHref = `/${DEFAULT_LOCALE.path}/`.replace(/\/+/g, "/");
const fallbackLocale = SUPPORTED_LOCALES.find(
  locale => locale.code !== DEFAULT_LOCALE.code
);
const fallbackRedirectHref = fallbackLocale
  ? `/${fallbackLocale.path}/`.replace(/\/+/g, "/")
  : defaultRedirectHref;

const redirectScript = `
  const locales = ${JSON.stringify(localePaths)};
  const defaultHref = ${JSON.stringify(defaultRedirectHref)};

  const normalize = (value) => (value || "").toLowerCase();
  const browserLangs = (navigator.languages || [])
    .map(normalize)
    .filter(Boolean);
  if (!browserLangs.length && navigator.language) {
    browserLangs.push(normalize(navigator.language));
  }

  const match = locales.find(locale => {
    const aliasSet = locale.aliases.map(normalize);
    return browserLangs.some(lang => aliasSet.includes(lang) || aliasSet.includes(lang.split("-")[0]));
  });

  const target = match ? ("/" + (match.path || "") + "/").replace(/\/+/g, "/") : defaultHref;

  if (location.pathname !== target) {
    location.replace(target);
  }
`;
---

<!doctype html>
<html lang={DEFAULT_LOCALE.htmlLang}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Redirecting…</title>
    <meta http-equiv="refresh" content={`0; url=${defaultRedirectHref}`} />
    <script is:inline set:html={redirectScript} />
  </head>
  <body>
    <p>Redirecting to your preferred language…</p>
    <p>
      If you are not redirected automatically, please visit
      <a href={defaultRedirectHref}>{DEFAULT_LOCALE.name}</a>
      {
        fallbackLocale && (
          <>
            {" "}
            or <a href={fallbackRedirectHref}>{fallbackLocale.name}</a>.
          </>
        )
      }
    </p>
  </body>
</html>
