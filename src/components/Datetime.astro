---
import dayjs from "dayjs";
import utc from "dayjs/plugin/utc";
import timezone from "dayjs/plugin/timezone";
import IconCalendar from "@/assets/icons/IconCalendar.svg";
import { SITE } from "@/config";
import { t, getLangFromUrl } from "@/i18n";
import { DEFAULT_LOCALE, getLocaleConfig } from "@/i18n/config";

dayjs.extend(utc);
dayjs.extend(timezone);

export interface Props {
  class?: string;
  size?: "sm" | "lg";
  timezone: string | undefined;
  pubDatetime: string | Date;
  modDatetime: string | Date | undefined | null;
  showLabel?: boolean;
}

const {
  pubDatetime,
  modDatetime,
  size = "sm",
  class: className = "",
  timezone: postTimezone,
  showLabel = false,
} = Astro.props;

const currentLocale = getLangFromUrl(Astro.url);
const localeConfig = getLocaleConfig(currentLocale);
const fallbackLocaleConfig = getLocaleConfig(DEFAULT_LOCALE.code);

/* ========== Formatted Datetime ========== */
const tz = postTimezone || SITE.timezone;
const pub = dayjs(pubDatetime).tz(tz);
const mod = modDatetime ? dayjs(modDatetime).tz(tz) : null;
const isModified = Boolean(mod && mod.isAfter(pub));

// 动态加载 dayjs 语言包（如可用）
let activeDayjsLocale =
  localeConfig.dayjsLocale || fallbackLocaleConfig.dayjsLocale || "en";

try {
  if (localeConfig.dayjsLocale && !dayjs.Ls[localeConfig.dayjsLocale]) {
    await import(
      /* @vite-ignore */ `dayjs/locale/${localeConfig.dayjsLocale}.js`
    );
  }
  if (localeConfig.dayjsLocale && dayjs.Ls[localeConfig.dayjsLocale]) {
    activeDayjsLocale = localeConfig.dayjsLocale;
  }
} catch {
  activeDayjsLocale = fallbackLocaleConfig.dayjsLocale || "en";
}

// Format date based on locale configuration
const formatPattern =
  localeConfig.dateFormat || fallbackLocaleConfig.dateFormat || "YYYY-MM-DD";

const pubDate = pub.locale(activeDayjsLocale).format(formatPattern);
const modDate =
  isModified && mod
    ? mod.locale(activeDayjsLocale).format(formatPattern)
    : undefined;

const effectiveDate = isModified && mod ? mod : pub;
const effectiveDateText = isModified && modDate ? modDate : pubDate;
const effectiveLabelKey = isModified ? "updatedOn" : "publishedOn";
---

<div
  class:list={[
    "flex items-start gap-x-2 opacity-80 sm:items-center",
    className,
  ]}
>
  <IconCalendar
    class:list={[
      "inline-block flex-none text-muted-foreground",
      { "size-5": size === "sm", "size-6": size === "lg" },
    ]}
  />

  {showLabel ? (
    <span class="flex min-w-0 flex-col gap-y-0.5 sm:flex-row sm:items-baseline sm:gap-x-1 sm:gap-y-0">
      <span
        class:list={[
          [
            "text-sm whitespace-nowrap break-keep",
            { "sm:text-base": size === "lg" },
          ],
        ]}
      >
        {t(effectiveLabelKey, currentLocale)}:
      </span>
      <time
        class:list={[
          [
            "text-sm whitespace-nowrap break-keep",
            { "sm:text-base": size === "lg" },
          ],
        ]}
        datetime={effectiveDate.toISOString()}
      >
        {effectiveDateText}
      </time>
    </span>
  ) : (
    <time
      class:list={[
        [
          "text-sm whitespace-nowrap break-keep",
          { "sm:text-base": size === "lg" },
        ],
      ]}
      datetime={effectiveDate.toISOString()}
    >
      {effectiveDateText}
    </time>
  )}
</div>
