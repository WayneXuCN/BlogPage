---
import { t, getLangFromUrl, getLocalizedUrl } from "@/i18n";
import { stripLocaleFromPath } from "@/i18n/config";

// Remove current url path and remove trailing slash if exists
const currentUrlPath = Astro.url.pathname.replace(/\/+$/, "");
const currentLocale = getLangFromUrl(Astro.url);
const { pathWithoutLocale } = stripLocaleFromPath(currentUrlPath || "/");

// Get url array from path
// eg: /zh/tags/tailwindcss => ['zh', 'tags', 'tailwindcss']
const pathSegments = pathWithoutLocale.split("/").filter(Boolean);
const breadcrumbList = pathSegments;

// if breadcrumb is Home > Posts > 1 <etc>
// replace Posts with Posts (page number)
if (breadcrumbList[0] === "posts" && breadcrumbList[1]) {
  breadcrumbList.splice(
    0,
    2,
    `${t("posts", currentLocale)} (page ${breadcrumbList[1] || 1})`
  );
}

// if breadcrumb is Home > Tags > [tag] > [page] <etc>
// replace [tag] > [page] with [tag] (page number)
if (breadcrumbList[0] === "tags" && !isNaN(Number(breadcrumbList[2]))) {
  breadcrumbList.splice(
    1,
    3,
    `${breadcrumbList[1]} ${Number(breadcrumbList[2]) === 1 ? "" : "(page " + breadcrumbList[2] + ")"}`
  );
}

// Function to build localized URL
function buildLocalizedUrl(segments: string[]): string {
  const path = "/" + segments.join("/");
  return getLocalizedUrl(path, currentLocale);
}
---

<nav class="mx-auto mt-8 mb-1 w-full max-w-app px-4" aria-label="breadcrumb">
  <ul
    class="font-light [&>li]:inline [&>li:not(:last-child)>a]:hover:opacity-100"
  >
    <li>
      <a href={getLocalizedUrl("/", currentLocale)} class="opacity-80"
        >{t("home", currentLocale)}</a
      >
      <span aria-hidden="true" class="opacity-80">&raquo;</span>
    </li>
    {
      breadcrumbList.map((breadcrumb, index) => {
        // Build the path up to this breadcrumb
        const segmentsToBreadcrumb = breadcrumbList.slice(0, index + 1);
        const isLastItem = index + 1 === breadcrumbList.length;

        // Translate common navigation items
        let displayText = breadcrumb;
        if (breadcrumb === "posts") displayText = t("posts", currentLocale);
        if (breadcrumb === "tags") displayText = t("tags", currentLocale);
        if (breadcrumb === "archives")
          displayText = t("archives", currentLocale);
        if (breadcrumb === "about") displayText = t("about", currentLocale);
        if (breadcrumb === "search") displayText = t("search", currentLocale);

        return isLastItem ? (
          <li>
            <span
              class:list={["capitalize opacity-75", { lowercase: index > 0 }]}
              aria-current="page"
            >
              {/* make the last part lowercase in Home > Tags > some-tag */}
              {decodeURIComponent(displayText)}
            </span>
          </li>
        ) : (
          <li>
            <a
              href={buildLocalizedUrl(segmentsToBreadcrumb)}
              class="capitalize opacity-70"
            >
              {displayText}
            </a>
            <span aria-hidden="true">&raquo;</span>
          </li>
        );
      })
    }
  </ul>
</nav>
